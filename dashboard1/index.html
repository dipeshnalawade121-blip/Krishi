<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Krishi Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#f6f7f9;--card:#fff;--muted:#6b7280;--line:#e5e7eb;--brand:#1f6feb;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{margin:0;font-size:22px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}
    .row{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
    .kpi h4{margin:0 0 6px;font-size:12px;color:var(--muted);letter-spacing:.2px}
    .kpi strong{font-size:22px}
    .section-title{margin:18px 0 10px;font-weight:600}
    .banners{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .banner-tile{border:1px dashed var(--line);border-radius:12px;min-height:160px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;background:#fafafa}
    .banner-tile img{max-width:100%;max-height:120px;border-radius:8px;border:1px solid var(--line)}
    .btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn.bad{background:var(--bad);color:#fff;border-color:var(--bad)}
    .btn.small{padding:6px 8px;font-size:12px}
    .flex{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    .tabs{display:flex;gap:16px;border-bottom:1px solid var(--line);margin-top:6px}
    .tab{padding:10px 0;cursor:pointer;border-bottom:2px solid transparent;color:var(--muted)}
    .tab.active{color:#111;border-color:#111;font-weight:600}
    .toolbar{display:flex;gap:8px;align-items:center;margin:10px 0}
    input[type="text"], input[type="number"]{border:1px solid var(--line);border-radius:8px;padding:8px 10px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    thead th{font-size:12px;color:var(--muted);text-align:left;background:#fafafa;border-bottom:1px solid var(--line);padding:10px}
    tbody td{padding:10px;border-bottom:1px solid var(--line)}
    tbody tr:hover{background:#fafafa}
    .pill{padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .note{color:var(--muted);font-size:12px}
    .progress{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:var(--brand);width:0}
    /* Modal */
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{background:#fff;border-radius:12px;border:1px solid var(--line);max-width:520px;width:100%;padding:16px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid1{display:grid;gap:10px}
    .thumb{width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Dashboard</h1>
      <div class="flex">
        <span class="note">Store Status:</span>
        <strong>[ON]</strong>
      </div>
    </header>

    <!-- KPIs -->
    <div class="card">
      <div class="flex" style="margin-bottom:10px">
        <div style="flex:1">
          <div class="note" style="margin-bottom:6px">Shop Setup Progress</div>
          <div class="progress"><span id="progressBar"></span></div>
        </div>
        <div class="right note">Max Products: 50 • Banners: 3</div>
      </div>
      <div class="row" id="kpiRow">
        <!-- filled by JS -->
      </div>
    </div>

    <!-- Banners -->
    <div class="card" style="margin-top:14px">
      <div class="flex">
        <div class="section-title">Shop Banners</div>
        <div class="right note">Recommended: 1200×500 JPG/PNG</div>
      </div>
      <div class="banners" id="bannerGrid"></div>
      <div class="flex" style="margin-top:10px">
        <button class="btn primary" id="saveBannersBtn">Save Changes</button>
        <span class="note" id="bannerMsg"></span>
      </div>
    </div>

    <!-- Products -->
    <div class="card" style="margin-top:14px">
      <div class="flex">
        <div class="section-title">Your Products (Max 50)</div>
        <div class="right note" id="slotNote"></div>
      </div>

      <div class="tabs" id="tabs"></div>

      <div class="toolbar">
        <input id="searchInput" type="text" placeholder="Search product by name" style="min-width:260px">
        <button class="btn primary right" id="addProductBtn">Add Product</button>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:90px">Image</th>
            <th>Product Name</th>
            <th style="width:100px">Price</th>
            <th style="width:160px">Category</th>
            <th style="width:130px">Actions</th>
          </tr>
        </thead>
        <tbody id="productBody"></tbody>
      </table>

      <div id="limitBanner" class="card" style="margin-top:10px;background:#ecfdf5;border-color:#bbf7d0">
        <span id="limitText" class="note">—</span>
      </div>
    </div>
  </div>

  <!-- Add/Edit Product Modal -->
  <div class="modal-bg" id="modalBg" aria-hidden="true">
    <div class="modal">
      <h3 id="modalTitle" style="margin:0 0 10px">Add Product</h3>
      <div class="grid2">
        <div class="grid1">
          <label>Name
            <input type="text" id="pName" placeholder="Product name">
          </label>
          <label>Price
            <input type="number" id="pPrice" min="0" step="1" placeholder="0">
          </label>
          <label>Category
            <select id="pCategory">
              <option>Crop Protection</option>
              <option>Crop Nutrition</option>
              <option>Seeds</option>
              <option>Hardware</option>
            </select>
          </label>
        </div>
        <div class="grid1">
          <label>Description
            <input type="text" id="pDesc" placeholder="Short description">
          </label>
          <label>Usage
            <input type="text" id="pUsage" placeholder="e.g., Apply during sowing">
          </label>
          <label class="flex">Image
            <input type="file" id="pImage" accept="image/*" />
            <img id="pPreview" class="thumb" alt="">
          </label>
        </div>
      </div>
      <div class="flex" style="margin-top:12px">
        <button class="btn primary" id="saveProductModalBtn">Save</button>
        <button class="btn" id="cancelModalBtn">Cancel</button>
        <span class="right note" id="modalMsg"></span>
      </div>
    </div>
  </div>

  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== CONFIG ======
    const BACKEND_BASE = 'http://localhost:3000'; // your Express base
    const SUPABASE_URL = 'https://adfxhdbkqbezzliycckx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkZnhoZGJrcWJlenpsaXljY2t4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMTIxNjMsImV4cCI6MjA3Njg4ODE2M30.VHyryBwx19-KbBbEDaE-aySr0tn-pCERk9NZXQRzsYU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // How you store user ID after login – adjust if needed.
    const USER_ID = localStorage.getItem('user_id') || sessionStorage.getItem('user_id');

    // ====== STATE ======
    const CATS = ['Crop Protection', 'Crop Nutrition', 'Seeds', 'Hardware'];
    let profile = null;                  // user data from backend
    let products = [];                   // array of product objects
    let banners = [];                    // array of 0..3 urls
    let activeCat = CATS[0];
    let editingId = null;                // product.id if editing

    // ====== HELPERS ======
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const byCat = (list, cat) => list.filter(p => p.category === cat);
    const genCode = () => 'PRD-' + Math.random().toString(36).slice(2, 10).toUpperCase();
    const nowISO = () => new Date().toISOString();
    const nextSlot = () => (products.reduce((m,p)=>Math.max(m, p.slot||0),0) + 1);

    function setProgress() {
      const used = products.length;
      const pct = Math.min(100, Math.round((used/50)*100));
      $('#progressBar').style.width = pct + '%';
      $('#slotNote').textContent = `Using ${used} of 50 slots`;
      const limitText = used >= 50 ? 'Product limit reached (50/50). Delete items to add more.' : 'You can add more products.';
      $('#limitText').textContent = limitText;
    }

    function renderKPIs() {
      const counts = {
        total: products.length,
        cp: byCat(products,'Crop Protection').length,
        cn: byCat(products,'Crop Nutrition').length,
        seeds: byCat(products,'Seeds').length,
        hw: byCat(products,'Hardware').length,
        banners: banners.length
      };
      const html = `
        <div class="kpi"><h4>1. Products Added</h4><strong>${counts.total} / 50</strong></div>
        <div class="kpi"><h4>2. Crop Protection Products</h4><strong>${counts.cp}</strong></div>
        <div class="kpi"><h4>3. Crop Nutrition Products</h4><strong>${counts.cn}</strong></div>
        <div class="kpi"><h4>4. Seeds Products</h4><strong>${counts.seeds}</strong></div>
        <div class="kpi"><h4>5. Hardware Products</h4><strong>${counts.hw}</strong></div>
        <div class="kpi"><h4>6. Banners Uploaded</h4><strong>${counts.banners} / 3</strong></div>
      `;
      $('#kpiRow').innerHTML = html;
      setProgress();
    }

    function renderTabs() {
      $('#tabs').innerHTML = CATS.map(cat => 
        `<div class="tab ${cat===activeCat?'active':''}" data-cat="${cat}">${cat}</div>`
      ).join('');
      $$('#tabs .tab').forEach(tab => tab.onclick = () => { activeCat = tab.dataset.cat; renderProducts(); renderTabs(); });
    }

    function renderBanners() {
      const grid = $('#bannerGrid');
      const cells = [0,1,2].map(i => {
        const url = banners[i] || '';
        return `
          <div class="banner-tile" data-index="${i}">
            ${url ? `<img src="${url}" alt="banner ${i+1}">` : `<div class="note">No banner</div>`}
            <div class="flex">
              <label class="btn small">
                Replace<input type="file" data-type="replace" data-idx="${i}" accept="image/*" style="display:none">
              </label>
              ${url ? `<button class="btn small" data-type="remove" data-idx="${i}">Remove</button>` : ''}
            </div>
          </div>`;
      }).join('');
      grid.innerHTML = cells;

      // wire up
      grid.querySelectorAll('input[type=file]').forEach(inp => {
        inp.onchange = async (e) => {
          const idx = Number(inp.dataset.idx);
          const file = e.target.files?.[0]; if (!file) return;
          const path = `${USER_ID}/banner${idx+1}.${file.name.split('.').pop() || 'jpg'}`;
          const { error } = await supabase.storage.from('banner-images').upload(path, file, { upsert: true });
          if (error) { $('#bannerMsg').textContent = 'Upload failed'; return; }
          const { data } = supabase.storage.from('banner-images').getPublicUrl(path);
          banners[idx] = data.publicUrl;
          renderBanners(); renderKPIs();
          $('#bannerMsg').textContent = 'Banner updated (not saved yet)';
        };
      });
      grid.querySelectorAll('button[data-type=remove]').forEach(btn => {
        btn.onclick = () => {
          const idx = Number(btn.dataset.idx);
          banners[idx] = undefined;
          // tidy compact array (no holes at end)
          const compact = banners.filter(Boolean);
          while (compact.length < 3) compact.push(undefined);
          banners = compact;
          renderBanners(); renderKPIs();
          $('#bannerMsg').textContent = 'Banner removed (not saved yet)';
        };
      });
    }

    function renderProducts() {
      const q = $('#searchInput').value.trim().toLowerCase();
      const list = byCat(products, activeCat).filter(p => p.name.toLowerCase().includes(q))
                    .sort((a,b)=> (a.slot||0) - (b.slot||0));

      $('#productBody').innerHTML = list.map(p => `
        <tr data-id="${p.id}">
          <td>${p.image_url ? `<img src="${p.image_url}" class="thumb" alt="">` : '<span class="note">No image</span>'}</td>
          <td>${p.name}</td>
          <td>₹ ${Number(p.price||0)}</td>
          <td><span class="pill">${p.category}</span></td>
          <td class="flex">
            <button class="btn small" data-action="edit">Edit</button>
            <button class="btn small bad" data-action="delete">Delete</button>
          </td>
        </tr>
      `).join('');

      // actions
      $('#productBody').querySelectorAll('button[data-action=edit]').forEach(b=>{
        b.onclick = () => openEdit(b.closest('tr').dataset.id);
      });
      $('#productBody').querySelectorAll('button[data-action=delete]').forEach(b=>{
        b.onclick = () => removeProduct(b.closest('tr').dataset.id);
      });
      renderKPIs();
    }

    function openAdd() {
      editingId = null;
      $('#modalTitle').textContent = 'Add Product';
      $('#pName').value = '';
      $('#pPrice').value = '';
      $('#pCategory').value = activeCat;
      $('#pDesc').value = '';
      $('#pUsage').value = '';
      $('#pImage').value = '';
      $('#pPreview').src = '';
      $('#modalMsg').textContent = '';
      $('#modalBg').style.display = 'flex';
    }
    function openEdit(id) {
      const p = products.find(x => x.id === id);
      if (!p) return;
      editingId = id;
      $('#modalTitle').textContent = 'Edit Product';
      $('#pName').value = p.name || '';
      $('#pPrice').value = p.price || '';
      $('#pCategory').value = p.category || activeCat;
      $('#pDesc').value = p.description || '';
      $('#pUsage').value = p.usage || '';
      $('#pPreview').src = p.image_url || '';
      $('#pImage').value = '';
      $('#modalMsg').textContent = '';
      $('#modalBg').style.display = 'flex';
    }
    function closeModal(){ $('#modalBg').style.display='none'; }

    async function saveProductFromModal() {
      const name = $('#pName').value.trim();
      const price = Number($('#pPrice').value || 0);
      const category = $('#pCategory').value;
      const description = $('#pDesc').value.trim();
      const usage = $('#pUsage').value.trim();
      const file = $('#pImage').files[0];

      if (!name) { $('#modalMsg').textContent='Name required'; return; }
      if (products.length >= 50 && !editingId) { $('#modalMsg').textContent='Limit 50 reached'; return; }

      let image_url = null;
      let code = editingId || genCode();

      if (file) {
        const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
        const path = `${USER_ID}/${code}.${ext}`;
        const { error: upErr } = await supabase.storage.from('product-images').upload(path, file, { upsert: true });
        if (upErr) { $('#modalMsg').textContent = 'Image upload failed'; return; }
        const { data } = supabase.storage.from('product-images').getPublicUrl(path);
        image_url = data.publicUrl;
      }

      if (editingId) {
        const idx = products.findIndex(p => p.id === editingId);
        const old = products[idx];
        products[idx] = {
          ...old,
          name, price, category, description, usage,
          image_url: image_url || old.image_url,
          updated_at: nowISO()
        };
      } else {
        products.push({
          id: code,
          slot: nextSlot(),
          name, price, category, description, usage,
          image_url: image_url || '',
          created_at: nowISO(),
          updated_at: nowISO()
        });
      }

      closeModal();
      renderProducts();
      // Persist to backend
      await saveProductsToBackend();
    }

    async function removeProduct(id) {
      if (!confirm('Delete this product?')) return;
      products = products.filter(p => p.id !== id);
      // Re-pack slots (keep simple increasing)
      let s = 1; products.sort((a,b)=>(a.slot||0)-(b.slot||0)).forEach(p=>p.slot=s++);
      renderProducts();
      await saveProductsToBackend();
    }

    async function saveBannersToBackend() {
      const clean = banners.filter(Boolean); // remove empties
      const res = await fetch(`${BACKEND_BASE}/save-banners`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id: USER_ID, banners: clean })
      });
      const json = await res.json();
      $('#bannerMsg').textContent = json.success ? 'Banners saved!' : (json.error || 'Save failed');
    }

    async function saveProductsToBackend() {
      const res = await fetch(`${BACKEND_BASE}/save-products`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id: USER_ID, products })
      });
      const json = await res.json();
      $('#limitText').textContent = json.success ? 'Products saved!' : (json.error || 'Save failed');
    }

    // ====== INIT LOAD ======
    async function init() {
      if (!USER_ID) {
        alert('No USER_ID found. Set localStorage.user_id after login.');
        return;
      }
      try {
        const res = await fetch(`${BACKEND_BASE}/get-user-profile`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id: USER_ID })
        });
        const out = await res.json();
        if (!out.success) throw new Error(out.error || 'Profile fetch error');

        profile = out.user || {};
        products = Array.isArray(profile.products) ? profile.products : [];
        banners = Array.isArray(profile.banners) ? profile.banners : [];

        renderKPIs();
        renderTabs();
        renderBanners();
        renderProducts();
      } catch (e) {
        console.error(e);
        alert('Failed to load dashboard.');
      }
    }

    // ====== EVENTS ======
    $('#addProductBtn').onclick = openAdd;
    $('#cancelModalBtn').onclick = closeModal;
    $('#saveProductModalBtn').onclick = saveProductFromModal;
    $('#pImage').onchange = (e)=>{ const f=e.target.files[0]; if(f){ $('#pPreview').src = URL.createObjectURL(f);} };
    $('#saveBannersBtn').onclick = saveBannersToBackend;
    $('#searchInput').oninput = renderProducts;

    // start
    init();
  </script>
</body>
</html>
