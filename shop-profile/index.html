<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Profile</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css' rel='stylesheet' />
    <!-- Mapbox Geocoding JS (for autocomplete) -->    
   
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
       
        :root {
            --primary-green: #059669; /* emerald-600 */
            --dark-bg: #0f172a; /* slate-900 */
            --dark-card: #1e293b; /* slate-800 */
            --dark-input: #0f172a; /* slate-900 */
            --dark-border: #334155; /* slate-700 */
            --light-text: #e2e8f0; /* slate-200 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg); /* Dark background */
            color: var(--light-text);
        }
        /* General dark input styles */
        .input-field-dark {
            background-color: var(--dark-input);
            border: 1px solid var(--dark-border);
            color: var(--light-text);
        }
        .input-field-dark:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 2px rgba(5, 150, 105, 0.4);
            outline: none;
        }
        /* Locked input styles (read-only) */
        .locked-input {
            background-color: #0f172a; /* Slightly darker than card for contrast */
            color: #94a3b8; /* Slate 400 */
            cursor: not-allowed;
            border-color: #334155;
        }
        /* Modal backdrop for darkening background */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        /* Hide number input arrows */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* Map container styles */
        #map {
            height: 300px;
            border-radius: 0.5rem;
            border: 1px solid var(--dark-border);
            background-color: var(--dark-input);
        }
        .mapbox-search-container {
            --mapbox-search-control-height: 40px;
        }
        #loader-overlay {
  position: fixed;
  inset: 0;
  background-color: rgba(15, 23, 42, 0.9);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.3s ease;
}

.loader {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: inline-block;
  border-top: 3px solid #4ADE80;
  border-right: 3px solid transparent;
  box-sizing: border-box;
  animation: rotation 1s linear infinite;
}

@keyframes rotation {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex justify-center items-start">
    <!-- Main Profile Container (Dark Card) -->
    <div id="app" class="w-full max-w-lg bg-slate-800 shadow-2xl rounded-xl p-6 sm:p-8">
       
        <!-- Header Section -->
        <div class="flex items-center space-x-2 mb-8">
            <svg class="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 12h-15m15 0a3 3 0 11-6 0 3 3 0 016 0zm-7.5 0a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <h1 class="text-2xl font-bold text-slate-100">Shop Profile</h1>
        </div>
        <!-- Notification/Status Message Area -->
        <div id="status-message" class="hidden p-3 mb-6 rounded-lg text-sm" role="alert"></div>
        <!-- Profile Form -->
        <form id="profile-form">
           
            <!-- Shop Name -->
            <div class="mb-4">
                <label for="shopName" class="block text-sm font-medium text-slate-400 mb-1">Shop Name</label>
                <input type="text" id="shopName" required maxlength="100"
                       class="w-full p-3 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 input-field-dark"
                       placeholder="Your Shop Name">
            </div>
            <!-- Shop Number -->
            <div class="mb-4">
                <label for="shopNumber" class="block text-sm font-medium text-slate-400 mb-1">Shop Contact Number</label>
                <div class="flex">
                    <span class="inline-flex items-center px-3 text-sm text-slate-200 bg-slate-700 border border-r-0 border-slate-600 rounded-l-lg">
                        +91
                    </span>
                    <input type="tel" id="shopNumber" required minlength="10" maxlength="10"
                           class="flex-1 p-3 rounded-r-lg input-field-dark focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition duration-150"
                           placeholder="10 digit number">
                </div>
            </div>
            <!-- Shop Address -->
            <div class="mb-4">
                <label for="shopAddress" class="block text-sm font-medium text-slate-400 mb-1">Shop Address</label>
                <textarea id="shopAddress" required rows="3" maxlength="500"
                          class="w-full p-3 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 input-field-dark resize-vertical"
                          placeholder="Full shop address (street, city, pincode, etc.)"></textarea>
                
                <!-- Map Container -->
                <div id="map" class="mt-2"></div>
            </div>
            <!-- Save Button -->
            <button type="submit" id="save-button"
                    class="w-full p-3 text-lg font-bold text-white bg-emerald-600 rounded-lg shadow-lg hover:bg-emerald-700 transition duration-150 focus:outline-none focus:ring-4 focus:ring-emerald-500 focus:ring-opacity-50 disabled:bg-gray-700"
                    disabled>
                Save Shop Profile
            </button>
        </form>
        <!-- Display User ID for debugging/reference -->
        <div class="mt-6 text-center text-xs text-slate-500">
            <p>Your User ID: <span id="user-id">Loading...</span></p>
        </div>
    </div>
   
    <!-- Custom Validation Error Modal Structure (Dark) -->
    <div id="error-modal" class="modal-backdrop hidden">
        <div class="bg-slate-800 p-6 rounded-xl shadow-2xl w-11/12 max-w-sm transform transition-all duration-300 scale-100 border border-slate-700">
            <div class="flex items-center space-x-3 mb-4">
                <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h3 class="text-xl font-bold text-slate-100">Validation Error</h3>
            </div>
            <p class="text-slate-400 mb-4">Please fix the following issues before updating your profile:</p>
            <ul id="modal-error-list" class="list-disc list-inside text-sm text-red-400 space-y-1 pl-4 mb-6">
                <!-- Errors will be inserted here -->
            </ul>
            <button id="close-modal-button"
                    class="w-full p-3 text-md font-semibold text-white bg-red-600 rounded-lg hover:bg-red-500 transition duration-150">
                Got It
            </button>
        </div>
    </div>
    <!-- Loader Overlay -->
<div id="loader-overlay">
  <span class="loader"></span>
</div>
    <!-- Logic -->
    <script type="module">
        // Backend URL for API calls
        const BACKEND_URL = 'https://api.krishi.site';
               // ---------- Loader Overlay Functions ----------
function showLoader() {
  const loader = document.getElementById('loader-overlay');
  loader.style.display = 'flex';
  loader.style.opacity = '1';
}
function hideLoader() {
  const loader = document.getElementById('loader-overlay');
  loader.style.opacity = '0';
  setTimeout(() => loader.style.display = 'none', 300);
}
        // Mapbox Token
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiZGlwZXNoNjM2NiIsImEiOiJjbWhraTZ1ZGgwYTFxMmlzYzdxcGlibzJnIn0.B62FIHq1WSsXbl_xcag-QA';
        // Detect user ID from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('id');
        document.getElementById('user-id').textContent = userId || 'N/A';
        let dbReady = false;
        const form = document.getElementById('profile-form');
        const saveButton = document.getElementById('save-button');
        const statusMessage = document.getElementById('status-message');
        const errorModal = document.getElementById('error-modal');
        const modalErrorList = document.getElementById('modal-error-list');
        const closeModalButton = document.getElementById('close-modal-button');
       
        // Input fields
        const inputShopName = document.getElementById('shopName');
        const inputShopNumber = document.getElementById('shopNumber');
        const inputShopAddress = document.getElementById('shopAddress');
        
       
        // Mapbox globals
        let map;
        let marker;

       
        // --- Helper Functions ---
        /**
         * Displays a status message to the user.
         * @param {string} message - The message content.
         * @param {string} type - 'success', 'error', or 'info'.
         */
        function displayStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `p-3 mb-6 rounded-lg text-sm transition-all duration-300 ${type === 'success' ? 'bg-green-900 text-green-300' : type === 'error' ? 'bg-red-900 text-red-300' : 'bg-blue-900 text-blue-300'}`;
            statusMessage.classList.remove('hidden');
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 5000);
        }
        function checkFormValidity() {
            const isValid = inputShopName.value.trim() && inputShopNumber.value.length === 10 && inputShopAddress.value.trim();
            saveButton.disabled = !isValid;
        }
        // --- Modal Functions ---
        function showModal(messages) {
            modalErrorList.innerHTML = messages.map(msg => `<li>${msg}</li>`).join('');
            errorModal.classList.remove('hidden');
        }
        function closeModal() {
            errorModal.classList.add('hidden');
        }
        closeModalButton.addEventListener('click', closeModal);
        // --- Validation Functions ---
        function validateForm() {
            const errors = [];
            if (!inputShopName.value.trim()) errors.push("Shop Name is required.");
            if (!inputShopNumber.value || inputShopNumber.value.length !== 10) {
                errors.push("Valid 10-digit shop contact number is required.");
            }
            if (!inputShopAddress.value.trim()) errors.push("Shop Address is required.");
            return errors;
        }
        
        // --- Mapbox Functions ---
        async function initMap() {
    mapboxgl.accessToken = MAPBOX_TOKEN;

    // Default center (India)
    const defaultCenter = [78.9629, 20.5937];
    const defaultZoom = 4;

    // Create the map
    map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: defaultCenter,
        zoom: defaultZoom
    });

    map.addControl(new mapboxgl.NavigationControl());

    // Wait until map fully loads before geolocation
    map.on('load', () => {
        console.log('ðŸ—ºï¸ Map fully loaded, requesting location...');

if (navigator.geolocation) {
  const success = (position) => {
    const userLng = position.coords.longitude;
    const userLat = position.coords.latitude;
    console.log('âœ… Got location:', userLat, userLng, 'accuracy Â±', position.coords.accuracy, 'm');

    map.flyTo({ center: [userLng, userLat], zoom: 14 });
    marker = new mapboxgl.Marker({ color: "#10B981" })
      .setLngLat([userLng, userLat])
      .addTo(map);

    displayStatus('Location found! Adjust marker near your shop.', 'success');
  };

  const error = (err) => {
    console.warn('âš ï¸ Location error:', err);
    displayStatus('Could not access location. Please click on map to set shop.', 'error');
  };

  // Try high accuracy first, fallback to low accuracy if it fails
  navigator.geolocation.getCurrentPosition(
    success,
    (err) => {
      console.warn('High accuracy failed, retrying low accuracy...');
      navigator.geolocation.getCurrentPosition(success, error, {
        enableHighAccuracy: false,
        timeout: 30000
      });
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
} else {
  displayStatus('Geolocation not supported on this device.', 'error');
}
    });

    // Handle manual map click to set shop position
    map.on('click', async (e) => {
        const coords = e.lngLat;
        if (marker) marker.remove();
        marker = new mapboxgl.Marker().setLngLat(coords).addTo(map);
        const address = await reverseGeocode(coords.lng, coords.lat);
        inputShopAddress.value = address;
        checkFormValidity();
        displayStatus('Shop location selected!', 'success');
    });
}

        async function reverseGeocode(lng, lat) {
            try {
                const res = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${MAPBOX_TOKEN}&language=en`);
                const data = await res.json();
                if (data.features.length > 0) {
                    return formatAddress(data.features[0]);
                }
                return 'Address not found';
            } catch (err) {
                console.error('Reverse geocoding failed:', err);
                return 'Address lookup failed';
            }
        }
        function formatAddress(item) {
            // Format as full address string
            const placeName = item.place_name || item.text || '';
            const address = item.address || '';
            const postcode = item.postcode ? ` ${item.postcode}` : '';
            const context = item.context ? item.context.map(c => c.text).join(', ') : '';
            return `${placeName}${address ? ', ' + address : ''}${postcode}, ${context}`.trim();
        }
        async function geocodeExistingAddress(address) {
            if (!address) return;
            try {
                const res = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${MAPBOX_TOKEN}&country=IN&language=en&limit=1`);
                const data = await res.json();
                if (data.features.length > 0) {
                    const coords = data.features[0].center;
                    map.flyTo({ center: coords, zoom: 15 });
                    if (marker) marker.remove();
                    marker = new mapboxgl.Marker().setLngLat(coords).addTo(map);
                }
            } catch (err) {
                console.error('Geocoding existing address failed:', err);
            }
        }
        // --- Save Function ---
        async function saveProfile(event) {
            event.preventDefault();
            const errors = validateForm();
            if (errors.length > 0) {
                showModal(errors);
                return;
            }
            saveButton.disabled = true;
            saveButton.textContent = 'Updating...';
            showLoader();
            // Construct the payload
            const payload = {
                id: userId,
                shop_name: inputShopName.value.trim(),
                shop_number: inputShopNumber.value.replace(/[^0-9]/g, ''), // Clean to digits
                shop_address: inputShopAddress.value.trim()
            };
            console.log('Saving shop profile with payload:', payload);
            try {
                const res = await fetch(`${BACKEND_URL}/save-shop-profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const responseText = await res.text();
                console.log('Raw server response:', responseText);
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse response as JSON:', responseText);
                    throw new Error(`Server returned invalid response: ${responseText.substring(0, 100)}`);
                }
                console.log('Save shop profile response:', data);
                if (!res.ok) {
                    throw new Error(data.error || `HTTP ${res.status}: ${res.statusText}`);
                }
                if (data.success) {
    displayStatus('Shop profile saved successfully! Redirecting...', 'success');

    // Get the user ID from backend response if available
    const redirectId = data.user?.id || userId;
    const googleId = urlParams.get('google_id'); // detect from URL if exists

    // Slight delay for better UX
    setTimeout(() => {
        const googleParam = googleId ? `google_id=${googleId}&` : '';
        window.location.href = `https://www.krishi.site/dashboard?${googleParam}id=${redirectId}`;
    }, 1200); // 1.2 seconds delay before redirect
} else {
    throw new Error(data.error || 'Shop profile save failed');
                }
            } catch (error) {
                console.error("Error updating shop profile:", error);
                displayStatus('Error updating shop profile: ' + error.message, 'error');
                hideLoader();
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Save Shop Profile';               
            }
        }
        // --- Load Profile ---
        async function loadProfile() {
            if (!userId) {
                displayStatus('No user ID found for profile lookup.', 'error');
                return;
            }
            const payload = { id: userId };
            try {
                const res = await fetch(`${BACKEND_URL}/get-user-profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const responseText = await res.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse profile response as JSON:', responseText);
                    throw new Error('Server returned invalid response');
                }
                if (!res.ok || !data.success || !data.user) {
                    throw new Error(data.error || 'Shop profile not found');
                }
                const user = data.user;
                inputShopName.value = user.shop_name || '';
                inputShopNumber.value = user.shop_number || '';
                inputShopAddress.value = user.shop_address || '';
                // Geocode existing address on map after init
                setTimeout(() => geocodeExistingAddress(user.shop_address), 1000);
                checkFormValidity();
            } catch (error) {
                console.error("Error loading shop profile:", error);
                displayStatus('Failed to load shop profile: ' + error.message, 'error');
            }
        }
       
        // --- Event Listeners ---
        inputShopNumber.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 10);
            checkFormValidity();
        });
        inputShopName.addEventListener('input', checkFormValidity);
        inputShopAddress.addEventListener('input', checkFormValidity);
        // --- Initialization ---
        async function initApp() {
            dbReady = true;
            await initMap(); // Init map first
            await loadProfile();
            form.addEventListener('submit', saveProfile);
            displayStatus('Shop profile ready with map!', 'success');
        }
        window.addEventListener('load', initApp);
       
        lucide.createIcons();
    </script>
</body>
</html>
